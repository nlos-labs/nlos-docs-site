name: Branch Protection Fallback

# This workflow provides basic branch protection for private repos
# without GitHub Pro by blocking direct commits to main that bypass CI
# and requiring CODEOWNERS approval validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-push:
    name: Validate Push to Main
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Check if push is from merged PR or infrastructure commit
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commit } = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });
            
            const message = commit.commit.message;
            console.log(`Commit message: ${message.split('\n')[0]}`);
            
            // Check if commit message indicates a PR merge
            const isMergeCommit = message.startsWith('Merge pull request #');
            const hasParents = commit.parents && commit.parents.length > 1;
            
            // Allow infrastructure setup commits (more flexible pattern)
            const isInfraCommit = message.match(/^(chore|ci|infra|feat|fix).*:.*\b(infrastructure|CI|workflow|setup|config)\b/i);
            
            console.log(`isMergeCommit: ${isMergeCommit}`);
            console.log(`hasParents: ${hasParents} (${commit.parents?.length || 0})`);
            console.log(`isInfraCommit: ${!!isInfraCommit}`);
            
            if (!isMergeCommit && !hasParents && !isInfraCommit) {
              core.setFailed('Direct commits to main are not allowed. Please create a pull request.');
            } else {
              if (isInfraCommit) {
                console.log('✅ Infrastructure setup commit - allowed');
              } else {
                console.log('✅ Push is from a merged PR');
              }
            }

  validate-codeowners:
    name: Validate CODEOWNERS Approval
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check CODEOWNERS approval
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Get PR files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            console.log(`Found ${reviews.length} reviews`);
            console.log(`Found ${files.length} files changed`);
            
            // Check for approvals
            const approvals = reviews.filter(r => r.state === 'APPROVED');
            console.log(`Found ${approvals.length} approvals`);
            
            if (approvals.length === 0) {
              core.warning('No approving reviews found. CODEOWNERS should review this PR.');
            } else {
              console.log('✅ PR has approving reviews');
            }

  require-ci-checks:
    name: Require CI Checks
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check CI status
        uses: actions/github-script@v7
        with:
          script: |
            // Get check runs for the PR head
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });
            
            console.log(`Found ${checkRuns.total_count} check runs`);
            
            // Look for CI check
            const ciCheck = checkRuns.check_runs.find(c => c.name === 'CI Pipeline');
            
            if (ciCheck) {
              console.log(`CI check status: ${ciCheck.status} - ${ciCheck.conclusion}`);
              if (ciCheck.conclusion === 'success') {
                console.log('✅ CI checks passed');
              } else if (ciCheck.status === 'completed') {
                core.setFailed('CI checks must pass before merging');
              } else {
                core.warning('CI checks are still running');
              }
            } else {
              core.warning('CI check not found - may still be queued');
            }
