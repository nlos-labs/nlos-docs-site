name: Branch Protection Fallback

on:
  push:
    branches: [main]

jobs:
  verify-protection:
    name: Verify Branch Protection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if commit is from merged PR
        id: check_pr
        run: |
          COMMIT_SHA="${{ github.sha }}"
          
          # Check if this commit has a PR associated
          PR_NUMBER=$(gh pr list --state merged --json number,mergeCommit \
            --jq ".[] | select(.mergeCommit.oid == \"$COMMIT_SHA\") | .number" || echo "")
          
          if [ -z "$PR_NUMBER" ]; then
            # Check if this is a direct push
            if [ "${{ github.event.forced }}" == "true" ]; then
              echo "❌ Force push detected on main branch!"
              exit 1
            fi
            
            # Allow commits from GitHub Actions or merge commits
            COMMITTER="${{ github.event.head_commit.committer.username }}"
            if [ "$COMMITTER" != "github-actions[bot]" ] && [ "$COMMITTER" != "web-flow" ]; then
              echo "⚠️  Warning: Direct commit to main branch detected!"
              echo "This should typically come from a merged PR."
              echo "Committer: $COMMITTER"
              # Don't fail, just warn for now
            fi
          else
            echo "✅ Commit is from merged PR #$PR_NUMBER"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Verify CI checks passed
        run: |
          COMMIT_SHA="${{ github.sha }}"
          
          # Wait a moment for CI to register
          sleep 5
          
          # Check if CI workflow exists and passed
          gh run list --commit "$COMMIT_SHA" --workflow ci.yml --json conclusion \
            --jq '.[0].conclusion' > /tmp/ci_status.txt || echo "none" > /tmp/ci_status.txt
          
          CI_STATUS=$(cat /tmp/ci_status.txt)
          
          if [ "$CI_STATUS" == "success" ]; then
            echo "✅ CI checks passed"
          elif [ "$CI_STATUS" == "none" ] || [ -z "$CI_STATUS" ]; then
            echo "⚠️  CI checks not found or still running"
          else
            echo "❌ CI checks failed with status: $CI_STATUS"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  codeowners-check:
    name: Verify CODEOWNERS Approval
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for CODEOWNERS approval
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get list of required teams from CODEOWNERS
          REQUIRED_TEAMS="devops-team"
          
          # Get PR reviews
          REVIEWS=$(gh pr view "$PR_NUMBER" --json reviews --jq '.reviews[].author.login')
          
          echo "Reviews received from: $REVIEWS"
          echo "This is a fallback check. Native branch protection should be enabled when GitHub Pro is active."
          
          # For now, just log the check
          echo "✅ CODEOWNERS check completed (fallback mode)"
        env:
          GH_TOKEN: ${{ github.token }}
